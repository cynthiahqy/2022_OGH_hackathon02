<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.629">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Hackathon Non-Submission</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="00_non-submission_files/libs/clipboard/clipboard.min.js"></script>
<script src="00_non-submission_files/libs/quarto-html/quarto.js"></script>
<script src="00_non-submission_files/libs/quarto-html/popper.min.js"></script>
<script src="00_non-submission_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="00_non-submission_files/libs/quarto-html/anchor.min.js"></script>
<link href="00_non-submission_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="00_non-submission_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="00_non-submission_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="00_non-submission_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="00_non-submission_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#replicating-existing-tutorials-and-code" id="toc-replicating-existing-tutorials-and-code" class="nav-link active" data-scroll-target="#replicating-existing-tutorials-and-code">Replicating Existing Tutorials and Code</a>
  <ul class="collapse">
  <li><a href="#opengeohub-usgs-ngs-soil-geochemicals-mapping-tutorial." id="toc-opengeohub-usgs-ngs-soil-geochemicals-mapping-tutorial." class="nav-link" data-scroll-target="#opengeohub-usgs-ngs-soil-geochemicals-mapping-tutorial.">OpenGeoHub USGS NGS <span><strong>soil geochemicals mapping tutorial</strong></span>.</a></li>
  <li><a href="#opengeohub-example-of-how-to-test-predictive-performance-of-a-ml-method-using-repeated-resampling" id="toc-opengeohub-example-of-how-to-test-predictive-performance-of-a-ml-method-using-repeated-resampling" class="nav-link" data-scroll-target="#opengeohub-example-of-how-to-test-predictive-performance-of-a-ml-method-using-repeated-resampling">OpenGeoHub&nbsp;<span><strong>example</strong></span> of how to test predictive performance of a ML method using repeated resampling</a></li>
  <li><a href="#scripts-from-debruin2022" id="toc-scripts-from-debruin2022" class="nav-link" data-scroll-target="#scripts-from-debruin2022">Scripts from <span class="citation" data-cites="debruin2022">Bruin et al. (<span>2022</span>)</span></a></li>
  </ul></li>
  <li><a href="#spatial-sampling-attempts" id="toc-spatial-sampling-attempts" class="nav-link" data-scroll-target="#spatial-sampling-attempts">Spatial Sampling Attempts</a>
  <ul class="collapse">
  <li><a href="#sampling-design" id="toc-sampling-design" class="nav-link" data-scroll-target="#sampling-design">Sampling Design</a></li>
  <li><a href="#implementation-attempts" id="toc-implementation-attempts" class="nav-link" data-scroll-target="#implementation-attempts">Implementation Attempts</a>
  <ul class="collapse">
  <li><a href="#spatial-clustering-using-spcosa" id="toc-spatial-clustering-using-spcosa" class="nav-link" data-scroll-target="#spatial-clustering-using-spcosa">Spatial Clustering Using <code>spcosa</code></a></li>
  <li><a href="#fold-sampling-function" id="toc-fold-sampling-function" class="nav-link" data-scroll-target="#fold-sampling-function">Fold sampling function</a></li>
  <li><a href="#resampling-inside-ml-framework" id="toc-resampling-inside-ml-framework" class="nav-link" data-scroll-target="#resampling-inside-ml-framework">Resampling inside ML framework</a></li>
  <li><a href="#using-cast" id="toc-using-cast" class="nav-link" data-scroll-target="#using-cast">Using CAST</a></li>
  </ul></li>
  <li><a href="#ml-issues" id="toc-ml-issues" class="nav-link" data-scroll-target="#ml-issues">ML Issues</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Hackathon Non-Submission</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>Laura and I spent probably about 8-10 hours over this week working on hackathon #2, and we couldn’t finish any of the requested tasks. However, I did learn a few things along the way.</p>
<p>Prior to this week, I had done zero spatial machine learning, no machine learning in R, and minimal spatial data manipulation in R. Laura was similarly inexperienced. Nevertheless, we tried the following: (note the code is not executable.. because time)</p>
<section id="replicating-existing-tutorials-and-code" class="level1">
<h1>Replicating Existing Tutorials and Code</h1>
<p>We cloned (as git submodules) or downloaded source code of the follow analyses:</p>
<section id="opengeohub-usgs-ngs-soil-geochemicals-mapping-tutorial." class="level3">
<h3 class="anchored" data-anchor-id="opengeohub-usgs-ngs-soil-geochemicals-mapping-tutorial.">OpenGeoHub USGS NGS <a href="https://opengeohub.github.io/spatial-prediction-eml/spatial-interpolation-in-3d-using-ensemble-ml.html"><strong>soil geochemicals mapping tutorial</strong></a>.</h3>
<ul>
<li><p>tutorial was quite difficult to follow from the rendered webpage as code chunks sometimes used functions or <code>.rds</code> objects not produced in the tutorial.</p></li>
<li><p>useful for roughly understanding the data provided, though it wasn’t so clear what to do with <code>chicago_grid1km.rds</code></p></li>
<li><p>also caused issues when trying to use code from <code>mlr3</code> tutorial because of conflicts between <code>mlr</code> and <code>mlr3</code>. <code>mlr3</code> task was empty after initiation with data until the .Rmd using <code>mlr</code> was closed and the session restarted (<a href="https://stackoverflow.com/questions/68576432/why-does-my-mlr3-classification-task-have-no-features">stackoverflow</a>).</p></li>
</ul>
</section>
<section id="opengeohub-example-of-how-to-test-predictive-performance-of-a-ml-method-using-repeated-resampling" class="level3">
<h3 class="anchored" data-anchor-id="opengeohub-example-of-how-to-test-predictive-performance-of-a-ml-method-using-repeated-resampling">OpenGeoHub&nbsp;<a href="https://opengeohub.github.io/spatial-sampling-ml/alt-text-resampling-methods-for-machine-learning.html#testing-mapping-accuracy-using-resampling-and-blocking"><strong>example</strong></a> of how to test predictive performance of a ML method using repeated resampling</h3>
<p>Planned to use for experiment stage, but we didn’t get there…</p>
</section>
<section id="scripts-from-debruin2022" class="level3">
<h3 class="anchored" data-anchor-id="scripts-from-debruin2022">Scripts from <span class="citation" data-cites="debruin2022">Bruin et al. (<a href="#ref-debruin2022" role="doc-biblioref">2022</a>)</span></h3>
<p>provided at: <a href="https://zenodo.org/record/6514923#.YxGjei8RrRY" class="uri">https://zenodo.org/record/6514923#.YxGjei8RrRY</a>. We roughly annotated the <code>sample_clustered.R</code> script to use as a basis for the hackathon sampling task.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1st case: 50% sample from 20% of the area</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234567</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_samp){</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="dv">100</span>, <span class="dv">20</span>)  <span class="do">## 100 spatial units, pick 20 to get 20% coverage</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  ndx <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, idx)  <span class="do">## remaining 80 units</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  msk1 <span class="ot">&lt;-</span> <span class="fu">mask</span>(msk, strata[idx,]) <span class="do">## msk is a boolean observation presence map</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  msk2 <span class="ot">&lt;-</span> <span class="fu">mask</span>(msk, strata[ndx,]) <span class="do">## select observations that match the </span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  sub <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">cells</span>(msk1), <span class="dv">2500</span>) <span class="do">## 2500 is 50% of the cells with observations available</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  sub <span class="ot">&lt;-</span> <span class="fu">c</span>(sub, <span class="fu">sample</span>(<span class="fu">cells</span>(msk2), <span class="dv">2500</span>)) <span class="do">## total training sample size appears to be 5000</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## not clear what the train/test ratio is (5000/??)</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  pts <span class="ot">&lt;-</span> <span class="fu">xyFromCell</span>(msk, sub)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  AGBdata <span class="ot">&lt;-</span> <span class="fu">extract</span>(AGBstack, sub)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  OCSdata <span class="ot">&lt;-</span> <span class="fu">extract</span>(OCSstack, sub)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  AGBdata<span class="sc">$</span>glc2017 <span class="ot">&lt;-</span> <span class="fu">factor</span>(AGBdata<span class="sc">$</span>glc2017, <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  OCSdata<span class="sc">$</span>glc2017 <span class="ot">&lt;-</span> <span class="fu">factor</span>(OCSdata<span class="sc">$</span>glc2017, <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"AGBdata"</span>, <span class="fu">sprintf</span>(<span class="st">"%03d"</span>, i), <span class="st">".Rdata"</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(AGBdata, <span class="at">file=</span><span class="fu">file.path</span>(outfolder, <span class="st">"clusterMedium"</span>, fname))</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"OCSdata"</span>, <span class="fu">sprintf</span>(<span class="st">"%03d"</span>, i), <span class="st">".Rdata"</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(OCSdata, <span class="at">file=</span><span class="fu">file.path</span>(outfolder, <span class="st">"clusterMedium"</span>, fname))</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2nd case: 90% sample from 10% of the area</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234567</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_samp){</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(<span class="dv">100</span>, <span class="dv">10</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  ndx <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, idx)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  msk1 <span class="ot">&lt;-</span> <span class="fu">mask</span>(msk, strata[idx,])</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  msk2 <span class="ot">&lt;-</span> <span class="fu">mask</span>(msk, strata[ndx,])</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  sub <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">cells</span>(msk1), <span class="dv">4500</span>)            <span class="do">## fixed training sample size of (5000)</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  sub <span class="ot">&lt;-</span> <span class="fu">c</span>(sub, <span class="fu">sample</span>(<span class="fu">cells</span>(msk2), <span class="dv">500</span>))</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  pts <span class="ot">&lt;-</span> <span class="fu">xyFromCell</span>(msk, sub)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  AGBdata <span class="ot">&lt;-</span> <span class="fu">extract</span>(AGBstack, sub)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  OCSdata <span class="ot">&lt;-</span> <span class="fu">extract</span>(OCSstack, sub)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  AGBdata<span class="sc">$</span>glc2017 <span class="ot">&lt;-</span> <span class="fu">factor</span>(AGBdata<span class="sc">$</span>glc2017, <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  OCSdata<span class="sc">$</span>glc2017 <span class="ot">&lt;-</span> <span class="fu">factor</span>(OCSdata<span class="sc">$</span>glc2017, <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"AGBdata"</span>, <span class="fu">sprintf</span>(<span class="st">"%03d"</span>, i), <span class="st">".Rdata"</span>)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(AGBdata, <span class="at">file=</span><span class="fu">file.path</span>(outfolder, <span class="st">"clusterStrong"</span>, fname))</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  fname <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"OCSdata"</span>, <span class="fu">sprintf</span>(<span class="st">"%03d"</span>, i), <span class="st">".Rdata"</span>)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(OCSdata, <span class="at">file=</span><span class="fu">file.path</span>(outfolder, <span class="st">"clusterStrong"</span>, fname))</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="spatial-sampling-attempts" class="level1">
<h1>Spatial Sampling Attempts</h1>
<p>Ignoring the feature space extrapolation, we tried the following for the spatial extrapolation questions:</p>
<section id="sampling-design" class="level2">
<h2 class="anchored" data-anchor-id="sampling-design">Sampling Design</h2>
<p>Understanding the required sampling strategy was quite difficult. For a <strong>fixed</strong> number of samples (e.g.&nbsp;in <code>ds801_geochem1km.rds</code>), depending on which dimension you randomise over first, the overall train/test ratio (probably?) needs to vary to achieve required sample percentage from extrapolation extent. In any case, collapsing the hierarchical sampling structure and detangling the inter-related constraints was very challenging. Assuming these issues are resolved into an clear experimental design, this task would probably be a lot easier with simulated data that is built up sequentially. Notice above in the <span class="citation" data-cites="debruin2022">Bruin et al. (<a href="#ref-debruin2022" role="doc-biblioref">2022</a>)</span> script the choice of fixed training sample size (<code>5000</code>), and partition of the overall extent into <code>100</code> spatial units to make selecting <code>x%</code> coverage easier.</p>
<p>The designation of the extrapolation and observed sets can be thought of as a (partly) deterministic process – i.e.&nbsp;based on some distance threshold, or correlation parameters; random subset of k-means generated clusters. Given extrapolation and observed set, we then consider what proportion of the test and training sets to sample from each set, which complicates holding constant other parameters of each experimental run (i.e.&nbsp;how to calculate the empty red question mark cells, given some experiment design constraints – same test/train set sizes etc.)</p>
<p><img src="https://lh4.googleusercontent.com/yKCP2LIPHa02jOlddd8onjNj2iMwr9YHZj33_TTPOShWOXHuqeQZ4-Vux_u_v1O9QCP2kyyJ44ZdI5jHVl82K516bl3Y24Fvc_-0G4oNIP1fDC_dHYB9bdc3AgFmeEHthQ3xJ932CjbdsIs9ogYKkLwHKIpmT6cKSTU6yvrL4BEujC54qnPYP_8ouK0.png" class="img-fluid" width="461"></p>
<p>Things that should be held constant</p>
<ul>
<li>number of folds, iterations</li>
<li>size of test/train sets</li>
<li><code>site_id</code> block samplines (i.e.&nbsp;don’t split up the depth observations between train/test)</li>
</ul>
</section>
<section id="implementation-attempts" class="level2">
<h2 class="anchored" data-anchor-id="implementation-attempts">Implementation Attempts</h2>
<section id="spatial-clustering-using-spcosa" class="level3">
<h3 class="anchored" data-anchor-id="spatial-clustering-using-spcosa">Spatial Clustering Using <code>spcosa</code></h3>
<p>Following <span class="citation" data-cites="debruin2022">Bruin et al. (<a href="#ref-debruin2022" role="doc-biblioref">2022</a>)</span> we tried to use <a href="https://cran.r-project.org/web/packages/spcosa/vignettes/spcosa.html"><code>{spcosa}</code></a> to do spatial clustering and create a <code>strata</code> overlay (with the intention of using it for sampling), but had difficulty installing the package (seemingly related to <code>{rjava}</code>).</p>
</section>
<section id="fold-sampling-function" class="level3">
<h3 class="anchored" data-anchor-id="fold-sampling-function">Fold sampling function</h3>
<p>The fold sampling function below does not preserve the <code>site_id</code> blocking, and has some maybe questionable default handling of cases where observations available in the extrapolation space are the sufficient to fill the proposed sampling percentage from extrapolation area.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>sample_clustered_fold <span class="ot">&lt;-</span> <span class="cf">function</span>(full_sample, cluster_var, cluster_cov_pct, cluster_train_pct){</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ---- check cluster_var is factor ----</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  cf <span class="ot">&lt;-</span> full_sample[,cluster_var]</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.factor</span>(cf[[cluster_var]]))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add row_id</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  cf<span class="sc">$</span>row_id <span class="ot">&lt;-</span> <span class="fu">seq_along</span>(cf[,<span class="dv">1</span>])</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ---- randomly select units in cluster ----</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculation variables</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  n_total_obs <span class="ot">&lt;-</span> <span class="fu">nrow</span>(cf)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  n_total_units <span class="ot">&lt;-</span> <span class="fu">nlevels</span>(cf[[cluster_var]]) </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  n_units_cluster <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(cluster_cov_pct <span class="sc">*</span> n_total_units)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># random sample</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  units_in_cluster <span class="ot">&lt;-</span> <span class="fu">sample</span>(cf[[cluster_var]], n_units_cluster)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ---- sample training rows from extrapolation clusters (up to available units) ---</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculation vars</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  cluster_bool <span class="ot">&lt;-</span> cf[[cluster_var]] <span class="sc">%in%</span> units_in_cluster</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  obs_extrap <span class="ot">&lt;-</span> cf[[<span class="st">"row_id"</span>]][cluster_bool] <span class="do">## ISSUE: how to deal with site_id grouping???</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  n_extrap_obs <span class="ot">&lt;-</span> <span class="fu">length</span>(obs_extrap)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  n_train_from_cluster <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(cluster_train_pct <span class="sc">*</span> n_train_obs)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># test/train sample from cluster</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  index <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(n_available_obs <span class="sc">&lt;=</span> n_train_from_cluster){</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    index<span class="sc">$</span>train<span class="sc">$</span>cluster <span class="ot">&lt;-</span> obs_extrap</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    n_train_from_cluster <span class="ot">&lt;-</span> n_available_obs</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    index<span class="sc">$</span>train<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="fu">sample</span>(obs_extrap, n_train_from_cluster)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  index<span class="sc">$</span>test<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(obs_in_cluster, index<span class="sc">$</span>train<span class="sc">$</span>cluster)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ---- sample training rows from in-sample clusters ----</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  pct_train <span class="ot">&lt;-</span> n_train_from_cluster <span class="sc">/</span> n_available_obs</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  obs_other <span class="ot">&lt;-</span> cf[[<span class="st">"row_id"</span>]][<span class="sc">!</span>cluster_bool]</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  n_train_from_other <span class="ot">=</span> pct_train <span class="sc">*</span> (n_total_obs <span class="sc">-</span> n_train_from_cluster)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  index<span class="sc">$</span>train<span class="sc">$</span>other <span class="ot">&lt;-</span> <span class="fu">sample</span>(obs_other, n_train_from_other)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  index<span class="sc">$</span>test<span class="sc">$</span>other <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(obs_other, index<span class="sc">$</span>test<span class="sc">$</span>other)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(index)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="resampling-inside-ml-framework" class="level3">
<h3 class="anchored" data-anchor-id="resampling-inside-ml-framework">Resampling inside ML framework</h3>
<p>We tried using the <code>{mlr3}</code> <code>Resampling</code> class in conjunction with <code>task$col_role$group</code> and <code>task$col_rol$stratum</code> options. The <code>"group"</code> takes only a single column, which should be used for <code>site_id</code> to ensure that observations at different depths are not separated. The <code>"stratum"</code> role can take multiple columns, which could allow for cross-dimension stratifcation units (e.g.&nbsp;space and time). However, it is not obvious if/how you can weight the proportion of the test/train sets that come from each <code>strata</code>. Each subpopulation is sampled independently (i.e.&nbsp;systematic random sampling), but if the same test/train ratio is applied to all subpopulations, each subpopulation will have equal representation in the final merged test set.</p>
<p>According to the <code>Resampling</code> class <a href="https://mlr3.mlr-org.com/reference/Resampling.html">documentation</a>:</p>
<blockquote class="blockquote">
<p>First, the observations are divided into subpopulations based one or multiple stratification variables (assumed to be discrete), c.f.&nbsp;<code>task$strata</code>.</p>
</blockquote>
<blockquote class="blockquote">
<p>Second, the sampling is performed in each of the&nbsp;<code>k</code>&nbsp;subpopulations separately. Each subgroup is divided into&nbsp;<code>iter</code>&nbsp;training sets and&nbsp;<code>iter</code>&nbsp;test sets by the derived&nbsp;<code>Resampling</code>. These sets are merged based on their iteration number: all training sets from all subpopulations with iteration 1 are combined, then all training sets with iteration 2, and so on. Same is done for all test sets. The merged sets can be accessed via&nbsp;<code>$train_set(i)</code>&nbsp;and&nbsp;<code>$test_set(i)</code>, respectively. Note that this procedure can lead to set sizes that are slightly different from those without stratification.</p>
</blockquote>
</section>
<section id="using-cast" class="level3">
<h3 class="anchored" data-anchor-id="using-cast">Using CAST</h3>
<p>An alternative approach would be what Hanna presented in the Extrapolation tutorial of generating the CV folds independently and then passing it to <code>mlr3</code> via <code>rsmp("custom")</code></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare Cross-validation</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>custom <span class="ot">&lt;-</span> <span class="fu">rsmp</span>(<span class="st">"custom"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="do">## no selection done by mlr3</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>train_sets <span class="ot">&lt;-</span> NNDM_cv<span class="sc">$</span>indx_train <span class="co"># derived from CAST::nndm</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>test_sets <span class="ot">&lt;-</span> NNDM_cv<span class="sc">$</span>indx_test <span class="co"># derived from CAST::nndm</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>rsmp_spcv_custom <span class="ot">&lt;-</span> custom<span class="sc">$</span><span class="fu">instantiate</span>(task, train_sets, test_sets) <span class="co">#create folds</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Model training and cross-validation</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(seed)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">&lt;-</span> mlr3<span class="sc">::</span><span class="fu">resample</span>(task, learner, rsmp_spcv_custom) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We attempted to create spatial folds just based on the state (because we didn’t know how to create and segment a sensible grid overlay):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ds801_sp <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(ds801, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>,<span class="st">"latitude"</span>))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(ds801_sp)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CAST)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>index <span class="ot">&lt;-</span> <span class="fu">CreateSpacetimeFolds</span>(ds801_sp,<span class="st">"state"</span>, <span class="at">k=</span><span class="dv">10</span>) <span class="do">## creates 10 folds</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>sub1 <span class="ot">&lt;-</span> ds801_sp[index<span class="sc">$</span>index[[<span class="dv">1</span>]],]      <span class="do">## 1/10 training set</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>sub2 <span class="ot">&lt;-</span> ds801_sp[index<span class="sc">$</span>indexOut[[<span class="dv">1</span>]],]   <span class="do">## 1/10 test set</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sub1[,<span class="st">'site_id'</span>])</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sub2[,<span class="st">'site_id'</span>],<span class="at">add=</span><span class="cn">TRUE</span>,<span class="at">col=</span><span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="ml-issues" class="level2">
<h2 class="anchored" data-anchor-id="ml-issues">ML Issues</h2>
<p>We didn’t really understand how the tuning and cross-validation in <code>{mlr3}</code> worked, and that resampling is (probably?) used both in tuning, and estimating the “experiment” RMSE.</p>

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-debruin2022" class="csl-entry" role="doc-biblioentry">
Bruin, Sytze de, Dick J. Brus, Gerard B. M. Heuvelink, Tom van Ebbenhorst Tengbergen, and Alexandre M.J-C. Wadoux. 2022. <span>“Dealing with Clustered Samples for Assessing Map Accuracy by Cross-Validation.”</span> <em>Ecological Informatics</em> 69 (July): 101665. <a href="https://doi.org/10.1016/j.ecoinf.2022.101665">https://doi.org/10.1016/j.ecoinf.2022.101665</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>